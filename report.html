<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SmartMock â€“ Reports</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }
      
      .report-card {
        background: linear-gradient(145deg, #ffffff 0%, #f5f7fa 100%);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
      }
      
      .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        border-color: #667eea;
      }
      
      .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      
      .report-score {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      
      .report-info h3 {
        margin: 0 0 5px 0;
        color: #2c3e50;
        font-size: 1.3em;
      }
      
      .report-date {
        color: #7f8c8d;
        font-size: 0.9em;
      }
      
      .report-details {
        margin: 15px 0;
        padding: 15px;
        background: rgba(102, 126, 234, 0.05);
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }
      
      .report-detail-item {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
        font-size: 0.95em;
      }
      
      .report-detail-label {
        color: #7f8c8d;
        font-weight: 500;
      }
      
      .report-detail-value {
        color: #2c3e50;
        font-weight: 600;
      }
      
      .report-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      
      .report-actions .btn {
        flex: 1;
        padding: 10px;
        font-size: 0.9em;
        text-align: center;
      }
      
      .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      
      .stat-card h3 {
        margin: 0;
        font-size: 2.5em;
        font-weight: bold;
      }
      
      .stat-card p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 0.95em;
      }
      
      .chart-container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin: 30px 0;
      }
      
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: linear-gradient(145deg, #f5f7fa 0%, #ffffff 100%);
        border-radius: 15px;
        border: 2px dashed #bdc3c7;
      }
      
      .empty-state h3 {
        color: #7f8c8d;
        margin-bottom: 15px;
      }
      
      .empty-state p {
        color: #95a5a6;
        margin-bottom: 20px;
      }
      
      .filter-section {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }
      
      .filter-section select {
        padding: 10px 15px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        font-size: 0.95em;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .filter-section select:hover {
        border-color: #667eea;
      }
      
      .loading {
        text-align: center;
        padding: 40px;
        font-size: 1.2em;
        color: #667eea;
      }
    </style>
      <style>
      /* Dark Black Theme with Purple Particles */
      body {
        background: #000000 !important;
        position: relative;
        overflow-x: hidden;
      }
      
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 50%, rgba(168, 85, 247, 0.05) 0%, transparent 70%);
        pointer-events: none;
        z-index: 0;
      }
      
      .particles-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }
      
      .particle {
        position: absolute;
        background: #a855f7;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(168, 85, 247, 0.5), 0 0 20px rgba(168, 85, 247, 0.5);
        opacity: 0;
        animation: floatUpward linear infinite;
      }
      
      @keyframes floatUpward {
        0% {
          transform: translateY(100vh) translateX(0) scale(0);
          opacity: 0;
        }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% {
          transform: translateY(-20vh) translateX(var(--drift)) scale(1);
          opacity: 0;
        }
      }
      
      header, main, section, .card, .hero-card, .auth-card, .report-card, .interview-container {
        position: relative;
        z-index: 10;
      }
      
      .site-header {
        background: rgba(10, 10, 10, 0.8) !important;
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(168, 85, 247, 0.2);
      }
      
      .card, .hero-card, .report-card {
        background: rgba(18, 18, 18, 0.8) !important;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(168, 85, 247, 0.2);
        transition: all 0.3s ease;
      }
      
      .card:hover, .hero-card:hover, .report-card:hover, .hover-card:hover {
        border-color: rgba(168, 85, 247, 0.5);
        box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
        transform: translateY(-5px);
      }
      
      .logo-accent {
        color: #a855f7 !important;
        text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
      }
      
      .btn.primary {
        background: linear-gradient(135deg, #a855f7, #d946ef) !important;
        box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
      }
      
      .btn.primary:hover {
        box-shadow: 0 15px 40px rgba(168, 85, 247, 0.6);
        transform: translateY(-2px);
      }
      
      .auth-card {
        background: rgba(18, 18, 18, 0.9) !important;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(168, 85, 247, 0.3);
        box-shadow: 0 20px 60px rgba(168, 85, 247, 0.3);
      }
    </style>
  
    <style>
      /* Dark Black Theme with Purple Particles & Parallax */
      body {
        background: #000000 !important;
        position: relative;
        overflow-x: hidden;
      }
      
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          circle at var(--gradient-x, 50%) var(--gradient-y, 50%), 
          rgba(168, 85, 247, 0.05) 0%, 
          transparent 70%
        );
        pointer-events: none;
        z-index: 0;
        will-change: transform;
        transition: background 0.3s ease;
      }
      
      .particles-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
        will-change: transform;
        transform-style: preserve-3d;
      }
      
      .particle {
        position: absolute;
        background: #a855f7;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(168, 85, 247, 0.5), 0 0 20px rgba(168, 85, 247, 0.5);
        opacity: 0;
        animation: floatUpward linear infinite;
      }
      
      @keyframes floatUpward {
        0% {
          transform: translateY(100vh) translateX(0) scale(0);
          opacity: 0;
        }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% {
          transform: translateY(-20vh) translateX(var(--drift)) scale(1);
          opacity: 0;
        }
      }
      
      header, main, section, .card, .hero-card, .auth-card, .report-card, .interview-container {
        position: relative;
        z-index: 10;
        will-change: transform;
        transform-style: preserve-3d;
      }
      
      .site-header {
        background: rgba(10, 10, 10, 0.8) !important;
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(168, 85, 247, 0.2);
        z-index: 2000 !important;
      }
      
      .card, .hero-card, .report-card {
        background: rgba(18, 18, 18, 0.8) !important;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(168, 85, 247, 0.2);
        transition: all 0.3s ease;
      }
      
      .card:hover, .hero-card:hover, .report-card:hover, .hover-card:hover {
        border-color: rgba(168, 85, 247, 0.5);
        box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
        transform: translateY(-5px);
      }
      
      .logo-accent {
        color: #a855f7 !important;
        text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
      }
      
      .btn.primary {
        background: linear-gradient(135deg, #a855f7, #d946ef) !important;
        box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
      }
      
      .btn.primary:hover {
        box-shadow: 0 15px 40px rgba(168, 85, 247, 0.6);
        transform: translateY(-2px);
      }
      
      .auth-card {
        background: rgba(18, 18, 18, 0.9) !important;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(168, 85, 247, 0.3);
        box-shadow: 0 20px 60px rgba(168, 85, 247, 0.3);
      }
    </style>
  </head>
  <body>
    <!-- Particles + Background Robot Containers (manual injection) -->
    <div class="particles-container" id="particlesContainer"></div>
    <div id="bg-robot-container"><canvas id="bg-robot-canvas"></canvas></div>
    <style>
      #bg-robot-container { position:fixed; inset:0; z-index: -1; pointer-events:none; }
      #bg-robot-container canvas { width:100%; height:100%; display:block; }
      .particles-container { z-index: 0; }
      .site-header { z-index: 2000 !important; }
      #menu-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(10px); display:none; z-index:1500; }
      #menu-panel { position:fixed; top:0; right:0; width:min(320px,80vw); height:100%; background:rgba(18,18,18,.9); border-left:1px solid rgba(168,85,247,.3); box-shadow:-10px 0 40px rgba(0,0,0,.4); transform:translateX(100%); transition:transform .3s ease; z-index:1600; }
      #menu-panel.open { transform:translateX(0); }
      body.menu-open #menu-overlay { display:block; }
    </style>
    <header class="site-header">
      <div class="site-header-inner container">
        <nav class="menu menu-left">
          <div class="menu-button">â˜° Menu</div>
          <ul class="dropdown">
            <li><a href="home.html">Home</a></li>
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="leaderboard.html">ðŸ† Leaderboard</a></li>
            <li class="has-submenu"><a href="interview.html">Interview</a>
              <ul class="submenu">
                <li><a href="interview/cs/ai-interview.html">AI Interview (CS)</a></li>
                <li><a href="interview/ee/ai-interview.html">AI Interview (EE)</a></li>
                <li><a href="interview/me/ai-interview.html">AI Interview (ME)</a></li>
                <li><a href="interview/ce/ai-interview.html">AI Interview (CE)</a></li>
                <li><a href="interview/ec/ai-interview.html">AI Interview (EC)</a></li>
              </ul>
            </li>
            <li><a href="about.html">About</a></li>
            <li><a href="report.html">Report</a></li>
            <li><a href="community.html">Community</a></li>
            <li><a href="verify-certificate.html">ðŸ” Verify Certificate</a></li>
            <li><a href="certificate.html">Certificate</a></li>
            <li><a href="contact.html">Contact Us</a></li>
            <li><a href="recruiter/dashboard.html">Recruiter Dashboard</a></li>
          </ul>
        </nav>
        <div class="brand"><a href="home.html"><span class="logo">Smart</span><span class="logo-accent">Mock</span></a></div>
        <div class="menu" style="margin-left:auto;">
          <a class="btn" href="profile.html">Profile</a>
          <a class="btn" href="#" onclick="signOut(); return false;">Sign out</a>
        </div>
      </div>
    </header>

    <main class="container">
      <section>
        <h2>ðŸ“Š Your Interview Reports</h2>
        
        <!-- Stats Overview -->
        <div class="stats-overview" id="stats-overview">
          <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h3 id="total-interviews">0</h3>
            <p>Total Interviews</p>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <h3 id="avg-score">0%</h3>
            <p>Average Score</p>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <h3 id="completed-interviews">0</h3>
            <p>Completed</p>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <h3 id="total-questions">0</h3>
            <p>Questions Answered</p>
          </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
          <select id="department-filter">
            <option value="all">All Departments</option>
            <option value="CS">Computer Science</option>
            <option value="EE">Electrical Engineering</option>
            <option value="ME">Mechanical Engineering</option>
            <option value="CE">Civil Engineering</option>
            <option value="EC">Electronic Communication</option>
          </select>
          <select id="sort-filter">
            <option value="recent">Most Recent</option>
            <option value="oldest">Oldest First</option>
            <option value="highest">Highest Score</option>
            <option value="lowest">Lowest Score</option>
          </select>
          <button class="btn" onclick="exportAllReports()">ðŸ“¥ Export All Reports</button>
        </div>

        <!-- Performance Chart -->
        <div class="chart-container">
          <h3>Performance Over Time</h3>
          <canvas id="performance-chart"></canvas>
        </div>

        <!-- Reports Grid -->
        <div id="reports-container">
          <div class="loading">ðŸ”„ Loading your reports...</div>
        </div>
      </section>
    </main>
    <footer class="site-footer">Â© <span id="year"></span> SmartMock.</footer>
    <script>document.getElementById('year').textContent = new Date().getFullYear();</script>
    
    <!-- Firebase SDK (must load FIRST) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- CRITICAL FIX: Load button fix AFTER Firebase SDK but BEFORE firebase-config -->
    <script src="assets/js/fix-buttons-global.js"></script>
        
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/auth-check.js"></script>
    <script>
      let allReports = [];
      let filteredReports = [];

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        loadReports();
      });

      async function loadReports() {
        const reportsContainer = document.getElementById('reports-container');
        
        try {
          const user = firebase.auth().currentUser;
          if (!user) {
            reportsContainer.innerHTML = `<div class="empty-state">
              <h3>ðŸ”’ Please Sign In</h3>
              <p>Sign in to view your interview reports</p>
              <a href="index.html" class="btn">Sign In</a>
            </div>`;
            return;
          }

          const userId = user.uid;
          const snapshot = await firebase.database().ref(`interviews/${userId}`).once('value');
          const data = snapshot.val();

          if (!data || Object.keys(data).length === 0) {
            reportsContainer.innerHTML = `<div class="empty-state">
              <h3>ðŸ“‹ No Reports Yet</h3>
              <p>Complete an AI interview to see your reports here</p>
              <a href="interview/cs/ai-interview.html" class="btn">Start Your First Interview</a>
            </div>`;
            return;
          }

          // Convert to array and sort
          allReports = Object.keys(data).map(key => ({
            id: key,
            ...data[key]
          })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

          filteredReports = [...allReports];
          
          // Update stats
          updateStats(allReports);
          
          // Display reports
          displayReports(filteredReports);
          
          // Create performance chart
          createPerformanceChart(allReports);

        } catch (error) {
          console.error('Error loading reports:', error);
          reportsContainer.innerHTML = `<div class="empty-state">
            <h3>âŒ Error Loading Reports</h3>
            <p>${error.message}</p>
          </div>`;
        }
      }

      function updateStats(reports) {
        const totalInterviews = reports.length;
        const completedInterviews = reports.filter(r => r.completed).length;
        const totalQuestions = reports.reduce((sum, r) => sum + (r.questionsAsked || 0), 0);
        const avgScore = reports.length > 0 
          ? (reports.reduce((sum, r) => sum + ((r.overallScore || 0) * 100), 0) / reports.length).toFixed(1)
          : 0;

        document.getElementById('total-interviews').textContent = totalInterviews;
        document.getElementById('avg-score').textContent = avgScore + '%';
        document.getElementById('completed-interviews').textContent = completedInterviews;
        document.getElementById('total-questions').textContent = totalQuestions;
      }

      function displayReports(reports) {
        const reportsContainer = document.getElementById('reports-container');
        
        if (reports.length === 0) {
          reportsContainer.innerHTML = `<div class="empty-state">
            <h3>ðŸ” No Reports Found</h3>
            <p>Try adjusting your filters</p>
          </div>`;
          return;
        }

        const html = `<div class="reports-grid">
          ${reports.map(report => createReportCard(report)).join('')}
        </div>`;
        
        reportsContainer.innerHTML = html;
      }

      function createReportCard(report) {
        const score = Math.round((report.overallScore || 0) * 100);
        const scoreColor = score >= 90 ? '#43e97b' : score >= 80 ? '#4facfe' : score >= 70 ? '#f093fb' : '#f5576c';
        const status = report.completed ? 'âœ… Completed' : 'â¸ï¸ Incomplete';
        const statusColor = report.completed ? '#43e97b' : '#f5576c';
        
        const dateObj = new Date(report.timestamp);
        const dateStr = dateObj.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        const deptName = getDepartmentName(report.department);
        const deptLower = (report.department || 'cs').toLowerCase();
        
        // Render stars
        const stars = report.stars || 0;
        let starsHTML = '<div class="stars-display" style="display: inline-flex; gap: 3px; font-size: 1.2em;">';
        for (let i = 0; i < 5; i++) {
          const color = i < stars ? '#FFD700' : '#E0E0E0';
          starsHTML += `<span style="color: ${color};">â˜…</span>`;
        }
        starsHTML += '</div>';

        return `
          <div class="report-card" onclick="window.location.href='interview/${deptLower}/ai-report.html?sessionId=${report.id}'">
            <div class="report-header">
              <div class="report-info">
                <h3>${deptName}</h3>
                <p class="report-date">${dateStr}</p>
                <p style="color: ${statusColor}; font-weight: 600; margin-top: 5px;">${status}</p>
              </div>
              <div class="report-score" style="background: linear-gradient(135deg, ${scoreColor} 0%, ${scoreColor}dd 100%);">
                ${score}%
              </div>
            </div>
            
            <div class="report-details">
              <div class="report-detail-item" style="border-bottom: 1px solid rgba(102, 126, 234, 0.1); padding-bottom: 8px; margin-bottom: 8px;">
                <span class="report-detail-label">â­ Rating:</span>
                <span class="report-detail-value">${starsHTML} ${report.grade || 'N/A'}</span>
              </div>
              <div class="report-detail-item">
                <span class="report-detail-label">ðŸ“š Topic:</span>
                <span class="report-detail-value">${report.topic || 'General'}</span>
              </div>
              <div class="report-detail-item">
                <span class="report-detail-label">ðŸ“Š Level:</span>
                <span class="report-detail-value">${report.level || 'Intermediate'}</span>
              </div>
              <div class="report-detail-item">
                <span class="report-detail-label">â“ Questions:</span>
                <span class="report-detail-value">${report.questionsAsked || 0}/${report.totalQuestions || 5}</span>
              </div>
              <div class="report-detail-item">
                <span class="report-detail-label">ðŸ’¬ Avg WPM:</span>
                <span class="report-detail-value">${Math.round(report.avgWPM || 0)}</span>
              </div>
              <div class="report-detail-item">
                <span class="report-detail-label">ðŸ˜Š Emotion:</span>
                <span class="report-detail-value">${report.dominantEmotion || 'neutral'}</span>
              </div>
            </div>
            
            <div class="report-actions" onclick="event.stopPropagation();">
              <button class="btn" onclick="window.location.href='interview/${deptLower}/ai-report.html?sessionId=${report.id}'">
                ðŸ“„ View Report
              </button>
              <button class="btn" style="background: transparent; border: 2px solid #667eea; color: #667eea;" onclick="downloadSingleReport('${report.id}')">
                ðŸ“¥ Export
              </button>
            </div>
          </div>
        `;
      }

      function getDepartmentName(dept) {
        const names = {
          'CS': 'ðŸ’» Computer Science',
          'EE': 'âš¡ Electrical Engineering',
          'ME': 'âš™ï¸ Mechanical Engineering',
          'CE': 'ðŸ—ï¸ Civil Engineering',
          'EC': 'ðŸ“¡ Electronic Communication'
        };
        return names[dept?.toUpperCase()] || 'ðŸŽ¯ Interview';
      }

      function createPerformanceChart(reports) {
        const ctx = document.getElementById('performance-chart').getContext('2d');
        
        // Get last 10 interviews
        const recentReports = reports.slice(0, 10).reverse();
        
        const labels = recentReports.map((r, i) => {
          const date = new Date(r.timestamp);
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        
        const scores = recentReports.map(r => ((r.overallScore || 0) * 100).toFixed(1));
        
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Interview Score (%)',
              data: scores,
              borderColor: 'rgba(102, 126, 234, 1)',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: 'rgba(102, 126, 234, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top',
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `Score: ${context.parsed.y}%`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
      }

      // Filter functions
      document.getElementById('department-filter')?.addEventListener('change', (e) => {
        const dept = e.target.value;
        if (dept === 'all') {
          filteredReports = [...allReports];
        } else {
          filteredReports = allReports.filter(r => r.department?.toUpperCase() === dept);
        }
        applySorting();
        displayReports(filteredReports);
      });

      document.getElementById('sort-filter')?.addEventListener('change', () => {
        applySorting();
        displayReports(filteredReports);
      });

      function applySorting() {
        const sortBy = document.getElementById('sort-filter').value;
        
        switch(sortBy) {
          case 'recent':
            filteredReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            break;
          case 'oldest':
            filteredReports.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            break;
          case 'highest':
            filteredReports.sort((a, b) => (b.overallScore || 0) - (a.overallScore || 0));
            break;
          case 'lowest':
            filteredReports.sort((a, b) => (a.overallScore || 0) - (b.overallScore || 0));
            break;
        }
      }

      // Export functions
      function downloadSingleReport(reportId) {
        const report = allReports.find(r => r.id === reportId);
        if (!report) return;
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(report, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `report-${reportId}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      }

      function exportAllReports() {
        if (allReports.length === 0) {
          alert('No reports to export');
          return;
        }

        const wb = XLSX.utils.book_new();

        // Summary Sheet
        const summaryData = [
          ['SmartMock Interview Reports Summary'],
          ['Generated:', new Date().toLocaleString()],
          [],
          ['Total Interviews:', allReports.length],
          ['Completed:', allReports.filter(r => r.completed).length],
          ['Average Score:', (allReports.reduce((sum, r) => sum + ((r.overallScore || 0) * 100), 0) / allReports.length).toFixed(2) + '%'],
          [],
          ['Session ID', 'Date', 'Department', 'Topic', 'Level', 'Score (%)', 'Questions', 'Avg WPM', 'Emotion', 'Status']
        ];

        allReports.forEach(report => {
          summaryData.push([
            report.id,
            new Date(report.timestamp).toLocaleString(),
            report.department || 'CS',
            report.topic || 'General',
            report.level || 'Intermediate',
            ((report.overallScore || 0) * 100).toFixed(1),
            `${report.questionsAsked || 0}/${report.totalQuestions || 5}`,
            Math.round(report.avgWPM || 0),
            report.dominantEmotion || 'neutral',
            report.completed ? 'Completed' : 'Incomplete'
          ]);
        });

        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

        // Individual report sheets (first 5)
        allReports.slice(0, 5).forEach((report, index) => {
          const reportData = [
            ['Interview Report'],
            ['Session ID:', report.id],
            ['Date:', new Date(report.timestamp).toLocaleString()],
            ['Department:', report.department || 'CS'],
            ['Topic:', report.topic || 'General'],
            ['Level:', report.level || 'Intermediate'],
            ['Overall Score:', ((report.overallScore || 0) * 100).toFixed(1) + '%'],
            ['Questions Answered:', `${report.questionsAsked || 0}/${report.totalQuestions || 5}`],
            ['Average WPM:', Math.round(report.avgWPM || 0)],
            ['Dominant Emotion:', report.dominantEmotion || 'neutral'],
            [],
            ['Questions & Answers']
          ];

          if (report.questions && report.questions.length > 0) {
            reportData.push(['#', 'Question', 'Answer', 'Score (%)', 'WPM']);
            report.questions.forEach((q, i) => {
              reportData.push([
                i + 1,
                q,
                report.answers?.[i] || 'N/A',
                report.score_list?.[i] ? (report.score_list[i] * 100).toFixed(0) : 'N/A',
                report.wpm_list?.[i] ? Math.round(report.wpm_list[i]) : 'N/A'
              ]);
            });
          }

          const wsReport = XLSX.utils.aoa_to_sheet(reportData);
          XLSX.utils.book_append_sheet(wb, wsReport, `Report ${index + 1}`);
        });

        XLSX.writeFile(wb, 'SmartMock_All_Reports.xlsx');
      }


    </script>
  
    <!-- Particle Generation Script -->
    <script>
      // Create 120 floating purple particles
      if (document.getElementById('particlesContainer')) {
        const particlesContainer = document.getElementById('particlesContainer');
        const particleCount = 120;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.classList.add('particle');
          
          // Random size (2-6px)
          const size = 2 + Math.random() * 4;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          
          // Random horizontal position
          const leftPos = Math.random() * 100;
          particle.style.left = `${leftPos}%`;
          
          // Random animation duration (12-25 seconds)
          const duration = 12 + Math.random() * 13;
          particle.style.animationDuration = `${duration}s`;
          
          // Random delay
          const delay = Math.random() * 10;
          particle.style.animationDelay = `${delay}s`;
          
          // Random horizontal drift
          const drift = (Math.random() - 0.5) * 150;
          particle.style.setProperty('--drift', `${drift}px`);
          
          particlesContainer.appendChild(particle);
        }
      }
    </script>
    <!-- Three.js + Robot + Overlay Init -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="assets/js/robot-interviewer.js"></script>
    <script>
      (function initBgRobot(){
        if(!document.getElementById('bg-robot-container')) return;
        if(typeof THREE==='undefined' || typeof window.RobotInterviewer==='undefined') return setTimeout(initBgRobot,120);
        try {
          if(!window.bgRobotGlobal){
            window.bgRobotGlobal = new window.RobotInterviewer('bg-robot-container', THREE, { canvasId:'bg-robot-canvas', trackCursor:true });
            window.bgRobotGlobal.setState('neutral');
            console.log('âœ… Background robot initialized (report)');
          }
        } catch(e){ console.error('Robot init failed', e); }
      })();
      (function initHamburger(){
        const menuBtn=document.querySelector('.menu-button');
        const dropdown=document.querySelector('.dropdown');
        if(!menuBtn||!dropdown) return;
        if(document.getElementById('menu-overlay')) return;
        const overlay=document.createElement('div'); overlay.id='menu-overlay'; document.body.appendChild(overlay);
        const panel=document.createElement('div'); panel.id='menu-panel'; document.body.appendChild(panel);
        const clone=dropdown.cloneNode(true); clone.style.display='block'; clone.style.padding='20px'; panel.appendChild(clone);
        function close(){ document.body.classList.remove('menu-open'); panel.classList.remove('open'); }
        menuBtn.addEventListener('click',e=>{e.preventDefault(); document.body.classList.add('menu-open'); panel.classList.add('open');});
        overlay.addEventListener('click', close);
        document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      })();
    </script>
  
    <!-- Particle Generation Script -->
    <script>
      // Create 120 floating purple particles
      if (document.getElementById('particlesContainer')) {
        const particlesContainer = document.getElementById('particlesContainer');
        const particleCount = 120;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.classList.add('particle');
          
          const size = 2 + Math.random() * 4;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          
          const leftPos = Math.random() * 100;
          particle.style.left = `${leftPos}%`;
          
          const duration = 12 + Math.random() * 13;
          particle.style.animationDuration = `${duration}s`;
          
          const delay = Math.random() * 10;
          particle.style.animationDelay = `${delay}s`;
          
          const drift = (Math.random() - 0.5) * 150;
          particle.style.setProperty('--drift', `${drift}px`);
          
          particlesContainer.appendChild(particle);
        }
      }
    </script>
    
    <!-- Three.js + Robot Interviewer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="assets/js/robot-interviewer.js"></script>
    <script>
      // Initialize Background Robot
      (function initBgRobot(){
        if (typeof THREE === 'undefined' || typeof window.RobotInterviewer === 'undefined') {
          return setTimeout(initBgRobot, 100);
        }
        try {
          window.bgRobot = new window.RobotInterviewer('bg-robot-container', THREE, {
            canvasId: 'bg-robot-canvas',
            trackCursor: true
          });
          window.bgRobot.setState('neutral');
          console.log('âœ… Background robot initialized');
        } catch (e) {
          console.error('âŒ Failed to init background robot:', e);
        }
      })();
      
      // Advanced Parallax and Depth Effect
      let targetX = 0, targetY = 0;
      let currentX = 0, currentY = 0;
      
      document.addEventListener('mousemove', (e) => {
        const x = e.clientX / window.innerWidth;
        const y = e.clientY / window.innerHeight;
        targetX = (x - 0.5);
        targetY = (y - 0.5);
      });
      
      function animateParallax() {
        currentX += (targetX - currentX) * 0.1;
        currentY += (targetY - currentY) * 0.1;
        
        const container = document.getElementById('bg-robot-container');
        if (container) {
          const moveX1 = currentX * 80;
          const moveY1 = currentY * 80;
          const rotateY1 = currentX * 20;
          const rotateX1 = -currentY * 20;
          const scale1 = 1 + (Math.abs(currentX) + Math.abs(currentY)) * 0.05;
          
          container.style.transform = `
            perspective(2000px) 
            translateX(${moveX1}px) 
            translateY(${moveY1}px) 
            translateZ(-100px)
            rotateX(${rotateX1}deg) 
            rotateY(${rotateY1}deg)
            scale(${scale1})
          `;
        }
        
        const particles = document.getElementById('particlesContainer');
        if (particles) {
          const moveX2 = currentX * 40;
          const moveY2 = currentY * 40;
          particles.style.transform = `
            translateX(${moveX2}px) 
            translateY(${moveY2}px)
            translateZ(50px)
          `;
        }
        
        const bodyBefore = document.body;
        if (bodyBefore) {
          const gradientX = 50 + currentX * 10;
          const gradientY = 50 + currentY * 10;
          bodyBefore.style.setProperty('--gradient-x', `${gradientX}%`);
          bodyBefore.style.setProperty('--gradient-y', `${gradientY}%`);
        }
        
        const main = document.querySelector('main');
        if (main) {
          const moveX4 = -currentX * 15;
          const moveY4 = -currentY * 15;
          main.style.transform = `
            translateX(${moveX4}px) 
            translateY(${moveY4}px)
            translateZ(100px)
          `;
        }
        
        requestAnimationFrame(animateParallax);
      }
      
      animateParallax();
    </script>
    <script src="assets/js/auto-purple-bg.js"></script>
  </body>
</html>
